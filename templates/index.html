<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¼ æ„Ÿå™¨æ§åˆ¶å°</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial;
            margin: 0;
        }
        #sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            padding: 10px;
        }
        #sidebar button {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #34495e;
            border: none;
            color: white;
            cursor: pointer;
        }
        #main {
            flex: 1;
            padding: 20px;
        }
        .device, .sensor-box {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button onclick="switchTab('dashboard')">Dashboard</button>
        <button onclick="switchTab('device')">è®¾å¤‡ç®¡ç†</button>
        <button onclick="switchTab('control')">æ§åˆ¶å°</button> <!-- âœ… æ–°å¢æ§åˆ¶å°æŒ‰é’® -->
        <button onclick="switchTab('database')">æ•°æ®åº“ç®¡ç†</button> <!-- âœ… æ–°å¢æ•°æ®åº“ç®¡ç†æŒ‰é’® -->
    </div>
    <div id="main">
        <div id="dashboard">
            <canvas id="temp-humi-chart" width="400" height="200"></canvas>
        </div>
        <div id="device" style="display:none"></div>
        <div id="control" style="display:none"></div> <!-- âœ… æ–°å¢æ§åˆ¶å°åŒºåŸŸ -->
        <div id="database" style="display:none">
            <h3>å®æ—¶æ•°æ®</h3>
            <div id="realtime-data"></div>
            <h3>å†å²æ•°æ®</h3>
            <input type="datetime-local" id="start-time">
            <input type="datetime-local" id="end-time">
            <button onclick="fetchHistoryData()">æŸ¥è¯¢</button>
            <div id="history-data"></div>
        </div>
    </div>

    <script>
        const socket = io();

        function switchTab(tab) {
         
            const tabs = ['dashboard', 'device', 'control', 'database'];
            tabs.forEach(id => {
                document.getElementById(id).style.display = (tab === id) ? 'block' : 'none';
            });
        }

        const dashboardMap = {};

        let tempHumiChart = null;

        function initializeChart() {
            const ctx = document.getElementById('temp-humi-chart').getContext('2d');
            tempHumiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // æ—¶é—´è½´
                    datasets: [
                        {
                            label: 'æ¸©åº¦ (â„ƒ)',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                        },
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'å€¼',
                            },
                            beginAtZero: true,
                        },
                    },
                },
            });
        }

        socket.on('dashboard_data', data => {
            let box = dashboardMap[data.addr];
            if (!box) {
                box = document.createElement('div');
                box.className = 'sensor-box';
                box.id = 'sensor-' + data.addr;
                document.getElementById('dashboard').appendChild(box);
                dashboardMap[data.addr] = box;
            }
            box.innerHTML = `<strong>${data.addr}</strong><br>ç±»å‹: ${data.type}<br>`;
            if (data.type === 'æ¸©æ¹¿åº¦') {
                box.innerHTML += `ğŸŒ¡ï¸ æ¸©åº¦: ${data.data.temp} â„ƒ<br>ğŸ’§ æ¹¿åº¦: ${data.data.humi} %`;

                // æ›´æ–°å›¾è¡¨æ•°æ®
                const currentTime = new Date().toLocaleTimeString();
                if (tempHumiChart) {
                    // é™åˆ¶å›¾è¡¨æ˜¾ç¤ºçš„æœ€å¤§æ•°æ®ç‚¹æ•°
                    const maxDataPoints = 10;

                    // æ›´æ–°æ¸©åº¦æ•°æ®
                    tempHumiChart.data.labels.push(currentTime);
                    tempHumiChart.data.datasets[0].data.push(data.data.temp);

                    // æ›´æ–°æ¹¿åº¦æ•°æ®
                    tempHumiChart.data.datasets[1].data.push(data.data.humi);

                    // ç§»é™¤å¤šä½™çš„æ•°æ®ç‚¹
                    if (tempHumiChart.data.labels.length > maxDataPoints) {
                        tempHumiChart.data.labels.shift();
                        tempHumiChart.data.datasets[0].data.shift();
                        tempHumiChart.data.datasets[1].data.shift();
                    }

                    tempHumiChart.update();
                }
            } else if (data.type === 'èœ‚é¸£å™¨' || data.type === 'é£æ‰‡') {
                box.innerHTML += `çŠ¶æ€: ${data.data.status}`;
                if (data.type === 'é£æ‰‡') {
                    const controlPanel = document.getElementById('control');
                    if (!document.getElementById('fan-control-' + data.addr)) {
                        const fanBox = document.createElement('div');
                        fanBox.className = 'sensor-box';
                        fanBox.id = 'fan-control-' + data.addr;
                        fanBox.innerHTML = `
                            <strong>${data.addr} - é£æ‰‡æ§åˆ¶</strong><br>
                            <button onclick="sendFanCommand('${data.addr}', true)">å¯åŠ¨</button>
                            <button onclick="sendFanCommand('${data.addr}', false)">å…³é—­</button>
                        `;
                        controlPanel.appendChild(fanBox);
                    }
                }
            } else {
                box.innerHTML += 'æ•°æ®æš‚æœªå¤„ç†';
            }
        });

        socket.on('client_list', list => {
            const deviceDiv = document.getElementById('device');
            deviceDiv.innerHTML = '<h3>è¿æ¥è®¾å¤‡åˆ—è¡¨</h3>';
            list.forEach(c => {
                const dev = document.createElement('div');
                dev.className = 'device';
                dev.innerHTML = `è®¾å¤‡ IP: ${c.addr}<br>ç±»å‹: ${c.type}`;
                deviceDiv.appendChild(dev);
            });
        });

        function sendFanCommand(target, on) {
            const msg = on ? 'AAOC02010F0200A10101016E' : 'AAOC02010F0200A10101006E';
            socket.emit('send_message', { message: msg, target: target });
        }

        socket.on('disconnected', data => {
            const addr = data.addr;
        
            // åˆ é™¤ dashboard ä¸­çš„å¡ç‰‡
            const sensorBox = document.getElementById('sensor-' + addr);
            if (sensorBox) {
                sensorBox.remove();
            }
        
            // åˆ é™¤æ§åˆ¶é¢æ¿é‡Œçš„é£æ‰‡æŒ‰é’®ç­‰
            const fanControl = document.getElementById('fan-control-' + addr);
            if (fanControl) {
                fanControl.remove();
            }
        
            console.log(`å®¢æˆ·ç«¯ ${addr} å·²æ–­å¼€ï¼Œç•Œé¢å·²æ¸…ç†`);
        });

        function fetchRealtimeData() {
            fetch('/api/realtime_data')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('realtime-data');
                    container.innerHTML = '';
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            æ—¶é—´: ${d.timestamp}<br>
                            ç±»å‹: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            æ¸©åº¦: ${d.temperature} â„ƒ<br>
                            æ¹¿åº¦: ${d.humidity} %
                        `;
                        container.appendChild(div);
                    });
                });
        }

        function fetchHistoryData() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const url = `/api/history_data?start_time=${startTime}&end_time=${endTime}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('history-data');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p>æ— æ•°æ®ç¬¦åˆæŸ¥è¯¢è¦æ±‚</p>'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                        return;
                    }
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            æ—¶é—´: ${d.timestamp}<br>
                            ç±»å‹: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            æ¸©åº¦: ${d.temperature} â„ƒ<br>
                            æ¹¿åº¦: ${d.humidity} %
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('æŸ¥è¯¢å†å²æ•°æ®æ—¶å‡ºé”™:', error);
                    const container = document.getElementById('history-data');
                    container.innerHTML = '<p>æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•</p>'; // æ˜¾ç¤ºé”™è¯¯æç¤º
                });
        }

        // Fetch realtime data every 5 seconds
        setInterval(fetchRealtimeData, 5000);

        window.onload = function () {
            initializeChart();
        };
    </script>
</body>
</html>
