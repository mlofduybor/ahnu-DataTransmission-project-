<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>传感器控制台</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial;
            margin: 0;
        }
        #sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            padding: 10px;
        }
        #sidebar button {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #34495e;
            border: none;
            color: white;
            cursor: pointer;
        }
        #main {
            flex: 1;
            padding: 20px;
        }
        .device, .sensor-box {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button onclick="switchTab('dashboard')">Dashboard</button>
        <button onclick="switchTab('device')">设备管理</button>
        <button onclick="switchTab('control')">控制台</button> <!-- ✅ 新增控制台按钮 -->
        <button onclick="switchTab('database')">数据库管理</button> <!-- ✅ 新增数据库管理按钮 -->
    </div>
    <div id="main">
        <div id="dashboard">
            <canvas id="temp-humi-chart" width="400" height="200"></canvas>
        </div>
        <div id="device" style="display:none"></div>
        <div id="control" style="display:none"></div> <!-- ✅ 新增控制台区域 -->
        <div id="database" style="display:none">
            <h3>实时数据</h3>
            <div id="realtime-data"></div>
            <h3>历史数据</h3>
            <input type="datetime-local" id="start-time">
            <input type="datetime-local" id="end-time">
            <button onclick="fetchHistoryData()">查询</button>
            <div id="history-data"></div>
        </div>
    </div>

    <script>
        const socket = io();

        function switchTab(tab) {
         
            const tabs = ['dashboard', 'device', 'control', 'database'];
            tabs.forEach(id => {
                document.getElementById(id).style.display = (tab === id) ? 'block' : 'none';
            });
        }

        const dashboardMap = {};

        let tempHumiChart = null;

        function initializeChart() {
            const ctx = document.getElementById('temp-humi-chart').getContext('2d');
            tempHumiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // 时间轴
                    datasets: [
                        {
                            label: '温度 (℃)',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                        },
                        {
                            label: '湿度 (%)',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: '值',
                            },
                            beginAtZero: true,
                        },
                    },
                },
            });
        }

        socket.on('dashboard_data', data => {
            let box = dashboardMap[data.addr];
            if (!box) {
                box = document.createElement('div');
                box.className = 'sensor-box';
                box.id = 'sensor-' + data.addr;
                document.getElementById('dashboard').appendChild(box);
                dashboardMap[data.addr] = box;
            }
            box.innerHTML = `<strong>${data.addr}</strong><br>类型: ${data.type}<br>`;
            if (data.type === '温湿度') {
                box.innerHTML += `🌡️ 温度: ${data.data.temp} ℃<br>💧 湿度: ${data.data.humi} %`;

                // 更新图表数据
                const currentTime = new Date().toLocaleTimeString();
                if (tempHumiChart) {
                    // 限制图表显示的最大数据点数
                    const maxDataPoints = 10;

                    // 更新温度数据
                    tempHumiChart.data.labels.push(currentTime);
                    tempHumiChart.data.datasets[0].data.push(data.data.temp);

                    // 更新湿度数据
                    tempHumiChart.data.datasets[1].data.push(data.data.humi);

                    // 移除多余的数据点
                    if (tempHumiChart.data.labels.length > maxDataPoints) {
                        tempHumiChart.data.labels.shift();
                        tempHumiChart.data.datasets[0].data.shift();
                        tempHumiChart.data.datasets[1].data.shift();
                    }

                    tempHumiChart.update();
                }
            } else if (data.type === '蜂鸣器' || data.type === '风扇') {
                box.innerHTML += `状态: ${data.data.status}`;
                if (data.type === '风扇') {
                    const controlPanel = document.getElementById('control');
                    if (!document.getElementById('fan-control-' + data.addr)) {
                        const fanBox = document.createElement('div');
                        fanBox.className = 'sensor-box';
                        fanBox.id = 'fan-control-' + data.addr;
                        fanBox.innerHTML = `
                            <strong>${data.addr} - 风扇控制</strong><br>
                            <button onclick="sendFanCommand('${data.addr}', true)">启动</button>
                            <button onclick="sendFanCommand('${data.addr}', false)">关闭</button>
                        `;
                        controlPanel.appendChild(fanBox);
                    }
                }
            } else {
                box.innerHTML += '数据暂未处理';
            }
        });

        socket.on('client_list', list => {
            const deviceDiv = document.getElementById('device');
            deviceDiv.innerHTML = '<h3>连接设备列表</h3>';
            list.forEach(c => {
                const dev = document.createElement('div');
                dev.className = 'device';
                dev.innerHTML = `设备 IP: ${c.addr}<br>类型: ${c.type}`;
                deviceDiv.appendChild(dev);
            });
        });

        function sendFanCommand(target, on) {
            const msg = on ? 'AAOC02010F0200A10101016E' : 'AAOC02010F0200A10101006E';
            socket.emit('send_message', { message: msg, target: target });
        }

        socket.on('disconnected', data => {
            const addr = data.addr;
        
            // 删除 dashboard 中的卡片
            const sensorBox = document.getElementById('sensor-' + addr);
            if (sensorBox) {
                sensorBox.remove();
            }
        
            // 删除控制面板里的风扇按钮等
            const fanControl = document.getElementById('fan-control-' + addr);
            if (fanControl) {
                fanControl.remove();
            }
        
            console.log(`客户端 ${addr} 已断开，界面已清理`);
        });

        function fetchRealtimeData() {
            fetch('/api/realtime_data')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('realtime-data');
                    container.innerHTML = '';
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            时间: ${d.timestamp}<br>
                            类型: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            温度: ${d.temperature} ℃<br>
                            湿度: ${d.humidity} %
                        `;
                        container.appendChild(div);
                    });
                });
        }

        function fetchHistoryData() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const url = `/api/history_data?start_time=${startTime}&end_time=${endTime}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('history-data');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p>无数据符合查询要求</p>'; // 如果没有数据，显示提示
                        return;
                    }
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            时间: ${d.timestamp}<br>
                            类型: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            温度: ${d.temperature} ℃<br>
                            湿度: ${d.humidity} %
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('查询历史数据时出错:', error);
                    const container = document.getElementById('history-data');
                    container.innerHTML = '<p>查询出错，请稍后重试</p>'; // 显示错误提示
                });
        }

        // Fetch realtime data every 5 seconds
        setInterval(fetchRealtimeData, 5000);

        window.onload = function () {
            initializeChart();
        };
    </script>
</body>
</html>
