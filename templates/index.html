<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¼ æ„Ÿå™¨æ§åˆ¶å°</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial;
            margin: 0;
        }
        #sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            padding: 10px;
        }
        #sidebar button {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #34495e;
            border: none;
            color: white;
            cursor: pointer;
        }
        #main {
            flex: 1;
            padding: 20px;
        }
        .device, .sensor-box {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button onclick="switchTab('dashboard')">Dashboard</button>
        <button onclick="switchTab('device')">è®¾å¤‡ç®¡ç†</button>
        <button onclick="switchTab('control')">æ§åˆ¶å°</button> <!-- âœ… æ–°å¢æ§åˆ¶å°æŒ‰é’® -->
        <button onclick="switchTab('database')">æ•°æ®åº“ç®¡ç†</button> <!-- âœ… æ–°å¢æ•°æ®åº“ç®¡ç†æŒ‰é’® -->
    </div>
    <div id="main">
        <div id="dashboard">
            <canvas id="temp-humi-chart" width="400" height="200"></canvas>
            <canvas id="light-chart" width="400" height="200"></canvas> <!-- å…‰ç…§å›¾è¡¨ -->
        </div>
        <div id="device" style="display:none"></div>
        <div id="control" style="display:none"></div> <!-- âœ… æ–°å¢æ§åˆ¶å°åŒºåŸŸ -->
        <div id="database" style="display:none">
            <div style="display: flex; justify-content: space-between;">
                <!-- æ¸©æ¹¿åº¦å®æ—¶æ•°æ® -->
                <div style="width: 48%;">
                    <h3>æ¸©æ¹¿åº¦å®æ—¶æ•°æ®</h3>
                    <div id="realtime-data"></div>
                </div>

                <!-- å…‰ç…§å®æ—¶æ•°æ® -->
                <div style="width: 48%;">
                    <h3>å…‰ç…§å®æ—¶æ•°æ®</h3>
                    <div id="realtime-light-data"></div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <div style="width: 48%;">
                    <h3>æ¸©æ¹¿åº¦å†å²æ•°æ®</h3>
                    <input type="datetime-local" id="start-time">
                    <input type="datetime-local" id="end-time">
                    <button onclick="fetchHistoryData()">æŸ¥è¯¢æ¸©æ¹¿åº¦</button>
                    <div id="history-data"></div>
                </div>

                <div style="width: 48%;">
                    <h3>å…‰ç…§å†å²æ•°æ®</h3>
                    <input type="datetime-local" id="light-start-time">
                    <input type="datetime-local" id="light-end-time">
                    <button onclick="fetchHistoryLight()">æŸ¥è¯¢å…‰ç…§</button>
                    <div id="history-light-data"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        let currentHumi = null; // å…¨å±€å˜é‡ï¼Œç”¨äºå­˜å‚¨å½“å‰æ¹¿åº¦å€¼

        function switchTab(tab) {
         
            const tabs = ['dashboard', 'device', 'control', 'database'];
            tabs.forEach(id => {
                document.getElementById(id).style.display = (tab === id) ? 'block' : 'none';
            });
        }

        const dashboardMap = {};

        let tempHumiChart = null;
        let lightChart = null;

        function initializeChart() {
            const ctx = document.getElementById('temp-humi-chart').getContext('2d');
            tempHumiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // æ—¶é—´è½´
                    datasets: [
                        {
                            label: 'æ¸©åº¦ (â„ƒ)',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: true,
                        },
                        {
                            label: 'æ¹¿åº¦ (%)',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: true,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'å€¼',
                            },
                            beginAtZero: true,
                        },
                    },
                },
            });
        }

        function initializeLightChart() {
            const ctx = document.getElementById('light-chart').getContext('2d');
            lightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // æ—¶é—´è½´
                    datasets: [
                        {
                            label: 'å…‰ç…§å€¼',
                            data: [],
                            borderColor: 'rgba(255, 206, 86, 1)',
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            fill: true,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´',
                            },
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'å…‰ç…§å€¼',
                            },
                            beginAtZero: true,
                        },
                    },
                },
            });
        }

        socket.on('dashboard_data', data => {
            let box = dashboardMap[data.addr];
            if (!box) {
                box = document.createElement('div');
                box.className = 'sensor-box';
                box.id = 'sensor-' + data.addr;
                document.getElementById('dashboard').appendChild(box);
                dashboardMap[data.addr] = box;
            }
            box.innerHTML = `<strong>${data.addr}</strong><br>ç±»å‹: ${data.type}<br>`;
            if (data.type === 'æ¸©æ¹¿åº¦') {
                const temp = data.data.temp;
                const humi = parseInt(data.data.humi, 10); // è½¬æ¢æ¹¿åº¦ä¸ºæ•´æ•°
                currentHumi = humi; // æ›´æ–°å…¨å±€å˜é‡
                box.innerHTML += `ğŸŒ¡ï¸ æ¸©åº¦: ${temp} â„ƒ<br>ğŸ’§ æ¹¿åº¦: ${humi} %`;

                // æ›´æ–°å›¾è¡¨æ•°æ®
                const currentTime = new Date().toLocaleTimeString();
                if (tempHumiChart) {
                    const maxDataPoints = 10;

                    tempHumiChart.data.labels.push(currentTime);
                    tempHumiChart.data.datasets[0].data.push(temp);
                    tempHumiChart.data.datasets[1].data.push(humi);

                    if (tempHumiChart.data.labels.length > maxDataPoints) {
                        tempHumiChart.data.labels.shift();
                        tempHumiChart.data.datasets[0].data.shift();
                        tempHumiChart.data.datasets[1].data.shift();
                    }

                    tempHumiChart.update();
                }
            } else if (data.type === 'å…‰ç…§') {
                box.innerHTML += `ğŸŒ å…‰ç…§å€¼: ${data.data.light}`;

                // æ›´æ–°å…‰ç…§å›¾è¡¨æ•°æ®
                const currentTime = new Date().toLocaleTimeString();
                if (lightChart) {
                    // é™åˆ¶å›¾è¡¨æ˜¾ç¤ºçš„æœ€å¤§æ•°æ®ç‚¹æ•°
                    const maxDataPoints = 10;

                    // æ›´æ–°å…‰ç…§æ•°æ®
                    lightChart.data.labels.push(currentTime);
                    lightChart.data.datasets[0].data.push(data.data.light);

                    // ç§»é™¤å¤šä½™çš„æ•°æ®ç‚¹
                    if (lightChart.data.labels.length > maxDataPoints) {
                        lightChart.data.labels.shift();
                        lightChart.data.datasets[0].data.shift();
                    }

                    lightChart.update();
                }
            } else if (data.type === 'èœ‚é¸£å™¨' || data.type === 'é£æ‰‡') {
                box.innerHTML += `çŠ¶æ€: ${data.data.status}`;
                if (data.type === 'é£æ‰‡') {
                    const controlPanel = document.getElementById('control');
                    if (!document.getElementById('fan-control-' + data.addr)) {
                        const fanBox = document.createElement('div');
                        fanBox.className = 'sensor-box';
                        fanBox.id = 'fan-control-' + data.addr;
                        fanBox.innerHTML = `
                            <strong>${data.addr} - é£æ‰‡æ§åˆ¶</strong><br>
                            <button onclick="sendFanCommand('${data.addr}', true)">å¯åŠ¨</button>
                            <button onclick="sendFanCommand('${data.addr}', false)">å…³é—­</button>
                        `;
                        controlPanel.appendChild(fanBox);
                    }
                }
            } else if (data.type === 'æ•°ç ç®¡') {
                // ä½¿ç”¨å…¨å±€å˜é‡ currentHumi åˆ¤æ–­æ¹¿åº¦å€¼
                if (currentHumi !== null) {
                    const humiColor = currentHumi > 50 ? 'red' : 'black';
                    box.innerHTML += `<span style="color: ${humiColor};">ğŸ’§ æ¹¿åº¦: ${currentHumi} %</span>`;

                    // è‡ªåŠ¨æ§åˆ¶é€»è¾‘
                    if (currentHumi > 70) {
                        sendSegCommand(data.addr, true); // æ¹¿åº¦å¤§äº50ï¼Œå¼€å¯æ•°ç ç®¡
                    } else {
                        sendSegCommand(data.addr, false); // æ¹¿åº¦å°äºç­‰äº50ï¼Œå…³é—­æ•°ç ç®¡
                    }
                } else {
                    box.innerHTML += `<span style="color: gray;">ğŸ’§ æ¹¿åº¦æ•°æ®ä¸å¯ç”¨</span>`;
                }

                // åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºæ•°ç ç®¡çŠ¶æ€
                const controlPanel = document.getElementById('control');
                if (!document.getElementById('seg-control-' + data.addr)) {
                    const segBox = document.createElement('div');
                    segBox.className = 'sensor-box';
                    segBox.id = 'seg-control-' + data.addr;
                    segBox.innerHTML = `
                        <strong>${data.addr} - æ•°ç ç®¡çŠ¶æ€</strong><br>
                        æ¹¿åº¦: <span style="color: ${currentHumi > 70 ? 'red' : 'black'};">${currentHumi !== null ? currentHumi + ' %' : 'ä¸å¯ç”¨'}</span>
                    `;
                    controlPanel.appendChild(segBox);
                } else {
                    // æ›´æ–°æ§åˆ¶å°ä¸­çš„æ¹¿åº¦æ˜¾ç¤º
                    const segBox = document.getElementById('seg-control-' + data.addr);
                    segBox.innerHTML = `
                        <strong>${data.addr} - æ•°ç ç®¡çŠ¶æ€</strong><br>
                        æ¹¿åº¦: <span style="color: ${currentHumi > 70 ? 'red' : 'black'};">${currentHumi !== null ? currentHumi + ' %' : 'ä¸å¯ç”¨'}</span>
                    `;
                }
            } else {
                box.innerHTML += 'æ•°æ®æš‚æœªå¤„ç†';
            }
        });

        socket.on('client_list', list => {
            const deviceDiv = document.getElementById('device');
            deviceDiv.innerHTML = '<h3>è¿æ¥è®¾å¤‡åˆ—è¡¨</h3>';
            list.forEach(c => {
                const dev = document.createElement('div');
                dev.className = 'device';
                dev.innerHTML = `è®¾å¤‡ IP: ${c.addr}<br>ç±»å‹: ${c.type}`;
                deviceDiv.appendChild(dev);
            });
        });

        function sendFanCommand(target, on) {
            const msg = on ? 'AAOC02010F0200A20101016E' : 'AAOC02010F0200A20101006E';
            socket.emit('send_message', { message: msg, target: target });
        }


        function sendSegCommand(target, on) {
            const msg = on ? 'AAOC02010F0200A40101016E' : 'AAOC02010F0200A40101006E';
            socket.emit('send_message', { message: msg, target: target });
        }



        socket.on('disconnected', data => {
            const addr = data.addr;
        
            // åˆ é™¤ dashboard ä¸­çš„å¡ç‰‡
            const sensorBox = document.getElementById('sensor-' + addr);
            if (sensorBox) {
                sensorBox.remove();
            }
        
            // åˆ é™¤æ§åˆ¶é¢æ¿é‡Œçš„é£æ‰‡æŒ‰é’®ç­‰
            const fanControl = document.getElementById('fan-control-' + addr);
            if (fanControl) {
                fanControl.remove();
            }
        
            console.log(`å®¢æˆ·ç«¯ ${addr} å·²æ–­å¼€ï¼Œç•Œé¢å·²æ¸…ç†`);
        });

        function fetchRealtimeData() {
            fetch('/api/realtime_data')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('realtime-data');
                    container.innerHTML = '';
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            æ—¶é—´: ${d.timestamp}<br>
                            ç±»å‹: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            æ¸©åº¦: ${d.temperature} â„ƒ<br>
                            æ¹¿åº¦: ${d.humidity} %
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('è·å–æ¸©æ¹¿åº¦å®æ—¶æ•°æ®æ—¶å‡ºé”™:', error);
                });
        }

        function fetchRealtimeLightData() {
            fetch('/api/realtime_light')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('realtime-light-data');
                    container.innerHTML = '';
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            æ—¶é—´: ${d.timestamp}<br>
                            ç±»å‹: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            å…‰ç…§å€¼: ${d.light_value}
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('è·å–å…‰ç…§å®æ—¶æ•°æ®æ—¶å‡ºé”™:', error);
                });
        }

        function fetchHistoryData() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;
            const url = `/api/history_data?start_time=${startTime}&end_time=${endTime}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('history-data');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p>æ— æ•°æ®ç¬¦åˆæŸ¥è¯¢è¦æ±‚</p>'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                        return;
                    }
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            æ—¶é—´: ${d.timestamp}<br>
                            ç±»å‹: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            æ¸©åº¦: ${d.temperature} â„ƒ<br>
                            æ¹¿åº¦: ${d.humidity} %
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('æŸ¥è¯¢å†å²æ•°æ®æ—¶å‡ºé”™:', error);
                    const container = document.getElementById('history-data');
                    container.innerHTML = '<p>æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•</p>'; // æ˜¾ç¤ºé”™è¯¯æç¤º
                });
        }

        function fetchHistoryLight() {
            const startTime = document.getElementById('light-start-time').value;
            const endTime = document.getElementById('light-end-time').value;
            const url = `/api/history_light?start_time=${startTime}&end_time=${endTime}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('history-light-data');
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p>æ— æ•°æ®ç¬¦åˆæŸ¥è¯¢è¦æ±‚</p>'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                        return;
                    }
                    data.forEach(d => {
                        const div = document.createElement('div');
                        div.className = 'sensor-box';
                        div.innerHTML = `
                            æ—¶é—´: ${d.timestamp}<br>
                            ç±»å‹: ${d.device_type}<br>
                            IP: ${d.ip}<br>
                            å…‰ç…§å€¼: ${d.light_value}
                        `;
                        container.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('æŸ¥è¯¢å…‰ç…§å†å²æ•°æ®æ—¶å‡ºé”™:', error);
                    const container = document.getElementById('history-light-data');
                    container.innerHTML = '<p>æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•</p>'; // æ˜¾ç¤ºé”™è¯¯æç¤º
                });
        }

        // Fetch realtime data every 5 seconds
        setInterval(() => {
            fetchRealtimeData();
            fetchRealtimeLightData();
        }, 5000);

        window.onload = function () {
            initializeChart();
            initializeLightChart();
            fetchRealtimeData();
            fetchRealtimeLightData();
        };
    </script>
</body>
</html>
