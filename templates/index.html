<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¼ æ„Ÿå™¨æ§åˆ¶å°</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial;
            margin: 0;
        }
        #sidebar {
            width: 200px;
            background: #2c3e50;
            color: white;
            height: 100vh;
            padding: 10px;
        }
        #sidebar button {
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #34495e;
            border: none;
            color: white;
            cursor: pointer;
        }
        #main {
            flex: 1;
            padding: 20px;
        }
        .device, .sensor-box {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <button onclick="switchTab('dashboard')">Dashboard</button>
        <button onclick="switchTab('device')">è®¾å¤‡ç®¡ç†</button>
        <button onclick="switchTab('control')">æ§åˆ¶å°</button> <!-- âœ… æ–°å¢æ§åˆ¶å°æŒ‰é’® -->
    </div>
    <div id="main">
        <div id="dashboard"></div>
        <div id="device" style="display:none"></div>
        <div id="control" style="display:none"></div> <!-- âœ… æ–°å¢æ§åˆ¶å°åŒºåŸŸ -->
    </div>

    <script>
        const socket = io();

        function switchTab(tab) {
         
            const tabs = ['dashboard', 'device', 'control'];
            tabs.forEach(id => {
                document.getElementById(id).style.display = (tab === id) ? 'block' : 'none';
            });
        }

        const dashboardMap = {};

        socket.on('dashboard_data', data => {
            let box = dashboardMap[data.addr];
            if (!box) {
                box = document.createElement('div');
                box.className = 'sensor-box';
                box.id = 'sensor-' + data.addr;
                document.getElementById('dashboard').appendChild(box);
                dashboardMap[data.addr] = box;
            }
            box.innerHTML = `<strong>${data.addr}</strong><br>ç±»å‹: ${data.type}<br>`;
            if (data.type === 'æ¸©æ¹¿åº¦') {
                box.innerHTML += `ğŸŒ¡ï¸ æ¸©åº¦: ${data.data.temp} â„ƒ<br>ğŸ’§ æ¹¿åº¦: ${data.data.humi} %`;
            } else if (data.type === 'èœ‚é¸£å™¨' || data.type === 'é£æ‰‡') {
                box.innerHTML += `çŠ¶æ€: ${data.data.status}`;
                if (data.type === 'é£æ‰‡') {
                    // åœ¨æ§åˆ¶å°ç”ŸæˆæŒ‰é’®
                const controlPanel = document.getElementById('control');
                if (!document.getElementById('fan-control-' + data.addr)) {
                    const fanBox = document.createElement('div');
                    fanBox.className = 'sensor-box';
                    fanBox.id = 'fan-control-' + data.addr;
                    fanBox.innerHTML = `
                        <strong>${data.addr} - é£æ‰‡æ§åˆ¶</strong><br>
                        <button onclick="sendFanCommand('${data.addr}', true)">å¯åŠ¨</button>
                        <button onclick="sendFanCommand('${data.addr}', false)">å…³é—­</button>
                    `;
                    controlPanel.appendChild(fanBox);
                }
            }
            } else {
                box.innerHTML += 'æ•°æ®æš‚æœªå¤„ç†';
            }
        });

        socket.on('client_list', list => {
            const deviceDiv = document.getElementById('device');
            deviceDiv.innerHTML = '<h3>è¿æ¥è®¾å¤‡åˆ—è¡¨</h3>';
            list.forEach(c => {
                const dev = document.createElement('div');
                dev.className = 'device';
                dev.innerHTML = `è®¾å¤‡ IP: ${c.addr}<br>ç±»å‹: ${c.type}`;
                deviceDiv.appendChild(dev);
            });
        });

        function sendFanCommand(target, on) {
            const msg = on ? 'AAOC02010F0200A10101016E' : 'AAOC02010F0200A10101006E';
            socket.emit('send_message', { message: msg, target: target });
        }

        socket.on('disconnected', data => {
            const addr = data.addr;
        
            // åˆ é™¤ dashboard ä¸­çš„å¡ç‰‡
            const sensorBox = document.getElementById('sensor-' + addr);
            if (sensorBox) {
                sensorBox.remove();
            }
        
            // åˆ é™¤æ§åˆ¶é¢æ¿é‡Œçš„é£æ‰‡æŒ‰é’®ç­‰
            const fanControl = document.getElementById('fan-control-' + addr);
            if (fanControl) {
                fanControl.remove();
            }
        
            console.log(`å®¢æˆ·ç«¯ ${addr} å·²æ–­å¼€ï¼Œç•Œé¢å·²æ¸…ç†`);
        });

    </script>
</body>
</html>
